32:      * V���-�rifie si le seuil de passage du quiz d'entr���-�e est valide
33:      * Le seuil doit ���-�tre strictement entre 0% et 100%
67:         // R���+����-�cup���+����-�rer les formations actuelles de l'���+����-�tudiant
70:         // R���+����-�cup���+����-�rer le nombre de formations disponibles pour l'���+����-�quipe
73:         // Ajouter les donn���+����-�es de progression pour chaque formation
88:             // Ajouter les informations de validation pour les formations termin���-�es
149:      * Afficher les d���+����-�tails d'une formation pour un ���+����-�tudiant
155:         // V���+����-�rifier si l'���+����-�tudiant est inscrit
157:             abort(403, 'Vous n\'���+����-�tes pas inscrit ���+����+� cette formation.');
160:         // V���+����-�rifier le quiz d'entr���+����-�e si la formation en a un
178:         // R���+����-�cup���+����-�rer la formation avec le progr���+����-+s de l'���+����-�tudiant
182:             abort(404, 'Formation non trouv���+����-�e ou non accessible.');
185:         // R���+����-�cup���+����-�rer le progr���+����-+s d���+����-�taill���+����-�
251:      * Afficher la page d���-�di���-�e aux formations termin���-�es
257:         // V���-�rifier si l'���-�tudiant est inscrit
259:             abort(403, 'Vous n\'���-�tes pas inscrit ���+� cette formation.');
262:         // V���-�rifier si la formation est termin���-�e
265:                 ->with('warning', 'Cette formation n\'est pas encore termin���-�e.');
268:         // R���-�cup���-�rer la formation avec le progr���-+s de l'���-�tudiant
272:             abort(404, 'Formation non trouv���-�e ou non accessible.');
275:         // R���-�cup���-�rer le progr���-+s d���-�taill���-�
280:         // R���-�cup���-�rer toutes les le���-�ons de la formation avec leur statut
330:         // R���-�cup���-�rer les donn���-�es de completion de la formation
352:      * Afficher la page de f���+����-�licitations pour une formation termin���+����-�e
360:             abort(403, 'Vous n\'etes pas inscrit ���+����+� cette formation.');
363:         // Marquer la formation comme termin���+����-�e (forcer le statut completed et progression ���+� 100%)
373:         // Recuperer la formation avec le progr���+����-+s de l'etudiant
432:         // V���-�rifier si c'est un document de formation standard
445:         // V���-�rifier si c'est un document joint de validation (format: completion-{index})
455:                 abort(404, 'Document non trouv���-�.');
461:                 abort(404, 'Fichier non trouv���-� sur le serveur.');
467:         abort(404, 'Document non trouv���-�.');
477:         // V���-�rifier si l'���-�tudiant est inscrit ���+� la formation
479:             abort(403, 'Vous n\'���-�tes pas inscrit ���+� cette formation.');
482:         // V���-�rifier si la formation est termin���-�e
487:         // R���-�cup���-�rer ou cr���-�er l'enregistrement FormationUser
494:         // V���-�rifier si une demande n'a pas d���-�j���+� ���-�t���-� faite
496:             return back()->with('warning', 'Une demande de validation est d���-�j���+� en cours de traitement.');
499:         // Cr���-�er la demande de validation
504:         return back()->with('success', 'Votre demande de validation de fin de formation a ���-�t���-� envoy���-�e avec succ���-+s. Un superadmin la traitera dans les plus brefs d���-�lais.');
508:      * T���-�l���-�charger la page de formation termin���-�e en PDF
514:         // V���-�rifier si l'���-�tudiant est inscrit
516:             abort(403, 'Vous n\'���-�tes pas inscrit ���+� cette formation.');
519:         // V���-�rifier si la formation est termin���-�e
522:                 ->with('warning', 'Cette formation n\'est pas encore termin���-�e.');
525:         // R���-�cup���-�rer les donn���-�es n���-�cessaires pour le PDF
530:         // R���-�cup���-�rer toutes les le���-�ons de la formation avec leur statut
580:         // R���-�cup���-�rer les donn���-�es de completion de la formation
587:         // G���-�n���-�rer le PDF
617:      * T���-�l���-�charger le rapport de connexion de l'���-�tudiant pour cette formation en PDF
623:         // V���-�rifier si l'���-�tudiant est inscrit
625:             abort(403, 'Vous n\'���-�tes pas inscrit ���+� cette formation.');
628:         // V���-�rifier si la formation est termin���-�e
631:                 ->with('warning', 'Cette formation n\'est pas encore termin���-�e.');
634:         // R���-�cup���-�rer les donn���-�es de la formation
638:         // R���-�cup���-�rer les donn���-�es de completion de la formation
644:         // R���-�cup���-�rer les logs d'activit���-� pour cette formation
651:                 // Filtrer les activit���-�s li���-�es ���+� cette formation
658:         // Grouper les activit���-�s par jour
671:                 'activities' => $logs->take(10), // Limiter ���+� 10 activit���-�s par jour pour le rapport
675:         // Statistiques g���-�n���-�rales
681:         // G���-�n���-�rer le PDF
711:      * Formater la dur���-�e en heures, minutes, secondes
739:         // V���+����-�rifier si l'���+����-�tudiant est d���+����-�j���+����+� inscrit
741:             return back()->with('warning', 'Vous ���+����-�tes d���+����-�j���+����+� inscrit ���+����+� cette formation.');
744:         // V���+����-�rifier si la formation est disponible pour cette ���+����-�quipe
750:             return back()->with('error', 'Cette formation n\'est pas disponible pour votre ���+����-�quipe.');
754:             return back()->with('error', 'Le solde de votre ���+����-�quipe est insuffisant pour cette formation.');
764:             // Rediriger vers le quiz d'entr���+����-�e si la formation en a un
768:                     ->with('info', 'Bienvenue dans cette formation ! Veuillez d\'abord passer le quiz d\'entr���+����-�e.');
771:             return back()->with('success', 'Vous avez ���+����-�t���+����-� inscrit ���+����+� la formation avec succ���+����-+s !');
780:      * R���+����-�initialiser le progr���+����-+s d'un ���+����-�tudiant dans une formation
786:         // V���+����-�rifier si l'���+����-�tudiant est inscrit ���+����+� cette formation
788:             return back()->with('error', 'Vous n\'���+����-�tes pas inscrit ���+����+� cette formation.');
792:             // R���+����-�cup���+����-�rer la premi���+����-+re le���+����-�on de la formation pour remettre current_lesson_id
800:             // R���+����-�initialiser le progr���+����-+s ���+����+� 0
808:             return back()->with('success', 'Le progr���+����-+s a ���+����-�t���+����-� r���+����-�initialis���+����-� avec succ���+����-+s.');
810:             return back()->with('error', 'Une erreur est survenue lors de la r���+����-�initialisation du progr���+����-+s.');
815:      * API endpoint pour r���+����-�cup���+����-�rer les formations d'un ���+����-�tudiant (pour AJAX)
832:      * API endpoint pour r���+����-�cup���+����-�rer la progression d'une formation
838:         // V���+����-�rifier les permissions
840:             return response()->json(['error' => 'Non autoris���+����-�'], 403);
853:      * Afficher le contenu d'une le���+����-�on
859:         // V���+����-�rifier si l'���+����-�tudiant est inscrit ���+����+� la formation
861:             abort(403, 'Vous n\'���+����-�tes pas inscrit ���+����+� cette formation.');
864:         // V���+����-�rifier que la le���+����-�on appartient bien au chapitre et ���+����+� la formation
866:             abort(404, 'Le���+����-�on non trouv���+����-�e.');
869:         // V���+����-�rifier le quiz d'entr���+����-�e si la formation en a un
880:                         ->with('error', 'Votre niveau actuel est insuffisant pour cette formation. Un formateur vous contactera pour vous orienter vers un parcours plus adapt+�.');
885:                         ->with('error', 'Votre niveau est trop +�lev+� pour cette formation. Un superadmin vous contactera pour vous proposer une formation plus adapt+�e.');
889:                     ->with('warning', 'Vous devez d\'abord passer le quiz d\'entr���+����-�e pour acc���+����-�der ���+����+� cette formation.');
893:         // V���+����-�rifier si la le���+����-�on est d���+����-�j���+����+� termin���+����-�e (sauf si c'est la premi���+����-+re visite)
898:                 ->with('info', 'Cette le���+����-�on est d���+����-�j���+����+� termin���+����-�e. Vous pouvez passer ���+����+� la le���+����-�on suivante.');
901:         // R���+����-�cup���+����-�rer le contenu de la le���+����-�on selon son type
923:             abort(404, 'Contenu de le���+����-�on non trouv���+����-�.');
926:         // D���+����-�marrer automatiquement la le���+����-�on lors de la visite (seulement si pas d���+����-�j���+����+� termin���+����-�e)
929:         // R���+����-�cup���+����-�rer la progression de l'���+����-�tudiant pour cette le���+����-�on
934:         // R���+����-�cup���+����-�rer les le���+����-�ons pr���+����-�c���+����-�dente et suivante dans le chapitre
945:         // R���+����-�cup���+����-�rer les autres chapitres de la formation pour la navigation
978:      * D���+����-�marrer automatiquement une le���+����-�on lors de la visite
984:         // Cr���+����-�er ou mettre ���+����+� jour la progression de l'���+����-�tudiant pour cette le���+����-�on
995:      * D���+����-�marrer une le���+����-�on (tracking du temps) - API endpoint
1001:         // V���+����-�rifier les permissions
1003:             return response()->json(['error' => 'Non autoris���+����-�'], 403);
1006:         // Cr���+����-�er ou mettre ���+����+� jour la progression de l'���+����-�tudiant pour cette le���+����-�on
1019:      * Marquer une le���+����-�on comme termin���+����-�e
1025:         // V���+����-�rifier les permissions
1027:             return response()->json(['error' => 'Non autoris���+����-�'], 403);
1030:         // Marquer la le���+����-�on comme termin���+����-�e
1039:         // Mettre ���+����+� jour la progression globale de la formation
1046:      * Mettre ���+����+� jour la progression d'une le���+����-�on (pour le contenu textuel)
1052:         // V���+����-�rifier les permissions
1054:             return response()->json(['error' => 'Non autoris���+����-�'], 403);
1059:         // Mettre ���+����+� jour la progression de lecture
1071:      * Afficher la page de quiz pour un ���+����-�tudiant
1077:         // V���+����-�rifier les permissions
1079:             abort(403, 'Vous n\'���+����-�tes pas inscrit ���+����+� cette formation.');
1082:         // V���+����-�rifier que la le���+����-�on est bien un quiz
1084:             abort(404, 'Quiz non trouv���+����-�.');
1089:         // R���+����-�cup���+����-�rer les questions du quiz
1092:         // V���+����-�rifier si l'���+����-�tudiant a d���+����-�j���+����+� atteint le nombre maximum de tentatives
1098:             // Marquer la le���+����-�on comme termin���+����-�e m���+����-�me si le quiz n'est pas r���+����-�ussi
1099:             // pour permettre ���+����+� l'���+����-�tudiant de continuer la formation
1104:                     'status' => 'completed', // ���+���++�+�+�-� Marquer comme termin���+����-� pour d���+����-�bloquer la progression
1109:             // Mettre ���+����+� jour la progression globale de la formation
1127:      * Soumettre les r���+����-�ponses d'un quiz
1134:             return response()->json(['error' => 'Non autoris���-�'], 403);
1138:             return response()->json(['error' => 'Quiz non trouv���-�'], 404);
1234:                 ->with('success', 'F���-�licitations ! Vous avez r���-�ussi le quiz avec un score de '.round($score, 1).'%.');
1241:             'message' => 'Quiz ���-�chou���-�. Vous pouvez r���-�essayer.',
1246:      * Afficher les r���+����-�sultats d'une tentative de quiz
1252:         // V���+����-�rifier les permissions
1254:             abort(403, 'Vous n\'���+����-�tes pas inscrit ���+����+� cette formation.');
1257:         // V���+����-�rifier que la le���+����-�on est bien un quiz
1259:             abort(404, 'Quiz non trouv���+����-�.');
1262:         // V���+����-�rifier que la tentative appartient ���+����+� l'utilisateur connect���+����-�
1264:             abort(403, 'Tentative non autoris���+����-�e.');
1269:         // R���+����-�cup���+����-�rer les r���+����-�ponses de cette tentative
1272:         // R���+����-�cup���+����-�rer les informations du quiz
1288:      * Mettre ���+����+� jour la progression globale d'une formation
1292:         // R���+����-�cup���+����-�rer tous les chapitres avec leurs le���+����-�ons et la progression de l'utilisateur
1301:         // Calculer la progression bas���+����-�e sur les le���+����-�ons termin���+����-�es
1316:         // Mettre ���+����+� jour la progression de la formation et le current_lesson_id
1319:         // Mettre ���+����+� jour la progression de la formation
1329:      * Mettre ���+����+� jour le current_lesson_id pour pointer vers la prochaine le���+����-�on non termin���+����-�e
1333:         // R���+����-�cup���+����-�rer la formation avec tous les chapitres et le���+����-�ons ordonn���+����-�s
1345:         // Parcourir tous les chapitres et le���+����-�ons pour trouver la premi���+����-+re non termin���+����-�e
1348:                 // V���+����-�rifier si cette le���+����-�on est termin���+����-�e
1354:                     // Cette le���+����-�on n'est pas termin���+����-�e, c'est la suivante
1361:         // Mettre ���+����+� jour le current_lesson_id dans formation_user
1371:      * Afficher le quiz d'entr���+����-�e pour un ���+����-�tudiant
1377:         // V���+����-�rifier si l'���+����-�tudiant est inscrit ���+����+� la formation
1379:             abort(403, 'Vous n\'���+����-�tes pas inscrit ���+����+� cette formation.');
1382:         // V���+����-�rifier si la formation a un quiz d'entr���+����-�e
1386:                 ->with('info', 'Cette formation n\'a pas de quiz d\'entr���+����-�e.');
1389:         // V���+����-�rifier si l'���+����-�tudiant a d���+����-�j���+����+� pass���+����-� le quiz d'entr���+����-�e
1397:                     ->with('error', 'Votre niveau actuel est insuffisant pour cette formation. Un formateur vous contactera pour vous orienter vers un parcours plus adapt+�.');
1402:                     ->with('error', 'Votre niveau est trop +�lev+� pour cette formation. Un superadmin vous contactera pour vous proposer une formation plus adapt+�e.');
1406:                 ->with('success', 'F+�licitations ! Votre niveau correspond parfaitement +� cette formation (score: '.round($entryScore, 1).'%). Vous pouvez maintenant commencer.');
1409:         // R���+����-�cup���+����-�rer les questions du quiz
1421:      * Soumettre les r���+����-�ponses du quiz d'entr���+����-�e
1427:         // V���+����-�rifier si l'���+����-�tudiant est inscrit ���+����+� la formation
1429:             return response()->json(['error' => 'Non autoris���+����-�'], 403);
1432:         // V���+����-�rifier si la formation a un quiz d'entr���+����-�e
1435:             return response()->json(['error' => 'Quiz d\'entr���+����-�e non trouv���+����-�'], 404);
1444:         // Mettre ���+����+� jour la progression de l'���+����-�tudiant dans la formation
1454:         // V���+����-�rifier si l'���+����-�tudiant a r���+����-�ussi le quiz
1459:                 ->with('error', 'Votre niveau actuel est insuffisant pour cette formation (score: '.round($result['score'], 1).'%). Un formateur vous contactera pour vous orienter vers un parcours plus adapt+�.');
1464:                 ->with('error', 'Votre niveau est trop +�lev+� pour cette formation (score: '.round($result['score'], 1).'%). Un superadmin vous contactera pour vous proposer une formation plus adapt+�e.');
1468:             ->with('success', 'F+�licitations ! Votre niveau correspond parfaitement +� cette formation (score: '.round($result['score'], 1).'%). Vous pouvez maintenant commencer.');
1472:      * Afficher les r���+����-�sultats du quiz d'entr���+����-�e
1478:         // V���+����-�rifier si l'���+����-�tudiant est inscrit ���+����+� la formation
1480:             abort(403, 'Vous n\'���+����-�tes pas inscrit ���+����+� cette formation.');
1483:         // V���+����-�rifier que la tentative appartient ���+����+� l'utilisateur connect���+����-�
1485:             abort(403, 'Tentative non autoris���+����-�e.');
1488:         // V���+����-�rifier que c'est bien une tentative de quiz d'entr���+����-�e
1490:             abort(404, 'R���+����-�sultats non trouv���+����-�s.');
1495:             abort(404, 'Quiz non trouv���+����-�.');
1498:         // R���+����-�cup���+����-�rer les r���+����-�ponses de cette tentative
1501:         // R���+����-�cup���+����-�rer les informations du quiz
1515:      * Soumettre un retour sur une formation termin���-�e
1521:         // V���-�rifier si l'���-�tudiant est inscrit ���+� la formation
1523:             abort(403, 'Vous n\'���-�tes pas inscrit ���+� cette formation.');
1526:         // V���-�rifier si la formation est termin���-�e
1536:         // R���-�cup���-�rer ou cr���-�er l'enregistrement FormationUser
1543:         // V���-�rifier si un retour a d���-�j���+� ���-�t���-� donn���-�
1545:             return back()->with('warning', 'Vous avez d���-�j���+� donn���-� votre retour pour cette formation.');
1554:         return back()->with('success', 'Merci pour votre retour ! Votre avis nous aide ���+� am���-�liorer nos formations.');
